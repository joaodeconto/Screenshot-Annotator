<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Screenshot Annotator ΓÇó OneΓÇæFile</title>
  <meta name="description" content="Fa├ºa anota├º├╡es em imagens: setas, caixas, texto, blur/pixelate e exporte ΓÇö tudo em um ├║nico HTML." />
  <style>
    :root{ --bg:#0b0c0f; --panel:#141720; --soft:#1b2030; --text:#eef1f5; --muted:#a9b2c3; --accent:#6ee7ff; --ring:#2a3348; }
    @media (prefers-color-scheme: light) { :root{ --bg:#f5f7fb; --panel:#ffffff; --soft:#eef2f9; --text:#0b1220; --muted:#5b6475; --accent:#006dff; --ring:#cfd8ea; } }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, rgba(110,231,255,.08), transparent 60%), radial-gradient(800px 600px at 100% 0%, rgba(0,109,255,.08), transparent 60%), var(--bg); color:var(--text); font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(1.2) blur(6px);background:color-mix(in oklab,var(--bg) 80%, transparent)}
    .wrap{max-width:1200px;margin-inline:auto;padding:16px}
    .title{font-size:clamp(22px,4vw,28px);font-weight:800;letter-spacing:.2px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--ring);background:var(--panel);color:var(--text);cursor:pointer}
    .btn[aria-pressed="true"]{outline:2px solid color-mix(in oklab, var(--accent) 60%, transparent)}
    .split{flex:1}
    input[type="color"], input[type="number"]{padding:8px;border-radius:10px;border:1px solid var(--ring);background:var(--panel);color:var(--text);width:90px}

    main{display:grid;grid-template-columns:1fr;gap:12px}
    .stage{background:var(--panel);border:1px dashed var(--ring);border-radius:14px;min-height:60vh;display:grid;place-items:center;overflow:auto}
    canvas{max-width:100%;height:auto;display:block}
    .hint{color:var(--muted);font-size:14px}

    .floating-editor{position:absolute;background:var(--panel);border:1px solid var(--ring);padding:10px 12px;border-radius:12px;color:var(--text);box-shadow:0 12px 40px rgba(0,0,0,.35);display:flex;flex-direction:column;gap:8px;z-index:20;min-width:220px}
    .floating-input{background:transparent;border:none;color:var(--text);font:600 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto;outline:none;width:100%}
    .floating-menu{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .floating-menu select,.floating-menu input[type="color"]{border:1px solid var(--ring);background:var(--soft);color:var(--text);border-radius:10px;padding:4px 8px;font:600 13px/1 system-ui,-apple-system,Segoe UI}
    .floating-menu input[type="color"]{padding:0;width:42px;height:36px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">Screenshot Annotator ΓÇó OneΓÇæFile</div>
      <div class="toolbar" role="toolbar" aria-label="Ferramentas">
        <input id="file" type="file" accept="image/*" class="btn" />
        <button class="btn" id="btnPaste">Colar (Ctrl/Γîÿ+V)</button>
        <div class="split"></div>
        <button class="btn" data-tool="arrow" aria-pressed="true">Seta</button>
        <button class="btn" data-tool="rect">Ret├óngulo</button>
        <button class="btn" data-tool="ellipse">Elipse</button>
        <button class="btn" data-tool="text">Texto</button>
        <button class="btn" data-tool="highlight">Marcador</button>
        <button class="btn" data-tool="redact">Redigir</button>
        <button class="btn" data-tool="blur">Pixelar</button>
        <div class="split"></div>
        <label class="btn" style="display:flex;gap:6px;align-items:center">Cor <input id="color" type="color" value="#ff5252" /></label>
        <label class="btn" style="display:flex;gap:6px;align-items:center">Espessura <input id="thick" type="number" value="8" min="1" max="64" /></label>
        <button class="btn" id="undo">Desfazer</button>
        <button class="btn" id="clear">Limpar</button>
        <button class="btn" id="copy">Copiar (Ctrl/⌘+C)</button>
        <button class="btn" id="export">Exportar PNG</button>
      </div>
      <div class="hint">Dica: arraste uma imagem, ou cole (Ctrl/Γîÿ+V). Clique e arraste para desenhar. Texto: clique para inserir.
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="stage" id="stage">
      <canvas id="c" width="1200" height="700" aria-label="├ürea de edi├º├úo"></canvas>
    </div>
  </main>

  <script>
  const c = document.getElementById('c');
  const ctx = c.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const file = document.getElementById('file');
  const stage = document.getElementById('stage');
  const tools = [...document.querySelectorAll('[data-tool]')];
  const color = document.getElementById('color');
  const thick = document.getElementById('thick');
  const undoBtn = document.getElementById('undo');
  const clearBtn = document.getElementById('clear');
  const exportBtn = document.getElementById('export');
  const pasteBtn = document.getElementById('btnPaste');
  const copyBtn = document.getElementById('copy');
  const copyBtnDefault = copyBtn ? copyBtn.textContent : '';

  let state = { tool:'arrow', down:false, start:null, img:null, history:[], floating:null, snapshot:null, lastPos:null };

  function removeFloatingEditor(){
    if(state.floating){
      state.floating.remove();
      state.floating=null;
    }
  }

  function setSize(w,h){
    const maxW = stage.clientWidth - 24; // padding
    const scale = Math.min(1, maxW / w);
    c.style.width = (w*scale)+'px';
    c.style.height = (h*scale)+'px';
    c.width = Math.round(w*dpr);
    c.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    redraw();
  }

  function captureCanvas(){
    try{
      return ctx.getImageData(0,0,c.width,c.height);
    }catch(e){
      return null;
    }
  }

  function restoreSnapshot(img){
    if(img){ ctx.putImageData(img,0,0); return; }
    const last = state.history.length ? state.history[state.history.length - 1] : null;
    if(last){ ctx.putImageData(last,0,0); }
    else drawBase();
  }

  function pushHistory(){
    const snap = captureCanvas();
    if(!snap) return;
    state.history.push(snap);
  }

  function undo(){
    if(state.history.length <= 1) return;
    state.history.pop();
    const previous = state.history[state.history.length - 1];
    if(previous) ctx.putImageData(previous,0,0);
  }

  function clear(){
    removeFloatingEditor();
    if(!state.img){ ctx.clearRect(0,0,c.width,c.height); return }
    drawBase();
    pushHistory();
  }

  function drawBase(){ ctx.clearRect(0,0,c.width,c.height); if(state.img){ ctx.drawImage(state.img,0,0,c.width/dpr,c.height/dpr); } }

  function redraw(){ drawBase(); }

  function setTool(name){ state.tool=name; tools.forEach(b=> b.setAttribute('aria-pressed', b.dataset.tool===name)); }

  tools.forEach(b=> b.addEventListener('click', ()=> setTool(b.dataset.tool)));

  // Load image
  function loadImage(src){
    const img=new Image();
    img.onload=()=>{
      removeFloatingEditor();
      state.img=img;
      state.history.length=0;
      state.snapshot=null;
      state.down=false;
      state.start=null;
      state.lastPos=null;
      setSize(img.naturalWidth, img.naturalHeight);
      drawBase();
      pushHistory();
    };
    img.src=src;
  }
  file.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> loadImage(r.result); r.readAsDataURL(f) })
  stage.addEventListener('dragover', e=>{ e.preventDefault(); })
  stage.addEventListener('drop', e=>{ e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f && f.type.startsWith('image/')){ const r=new FileReader(); r.onload=()=> loadImage(r.result); r.readAsDataURL(f) } })
  pasteBtn.addEventListener('click', async()=>{
    try{ const items = await navigator.clipboard.read(); for(const it of items){ for(const t of it.types){ if(t.startsWith('image/')){ const blob=await it.getType(t); loadImage(URL.createObjectURL(blob)); return } } } }catch(err){ alert('Permita acesso ao clipboard ou use Ctrl/Γîÿ+V'); }
  })
  window.addEventListener('paste', e=>{
    const items = e.clipboardData && e.clipboardData.items; if(!items) return;
    for(const it of items){ if(it.type.indexOf('image')>-1){ const blob=it.getAsFile(); loadImage(URL.createObjectURL(blob)); } }
  })

  // Drawing helpers
  function drawRect(a,b,fill=false, alpha=1){
    const x=Math.min(a.x,b.x), y=Math.min(a.y,b.y), w=Math.abs(a.x-b.x), h=Math.abs(a.y-b.y)
    if(fill){ ctx.globalAlpha=alpha; ctx.fillRect(x,y,w,h); ctx.globalAlpha=1; }
    else ctx.strokeRect(x,y,w,h)
  }

  function drawEllipse(a,b,fill=false, alpha=1){
    const x=Math.min(a.x,b.x), y=Math.min(a.y,b.y), w=Math.abs(a.x-b.x), h=Math.abs(a.y-b.y)
    ctx.beginPath(); ctx.ellipse(x+w/2,y+h/2,w/2,h/2,0,0,Math.PI*2)
    if(fill){ ctx.globalAlpha=alpha; ctx.fill(); ctx.globalAlpha=1; } else ctx.stroke();
  }

  function drawArrow(a,b){
    const dx=b.x-a.x, dy=b.y-a.y; const ang=Math.atan2(dy,dx);
    const head=Math.max(10, parseInt(thick.value,10)*2.5)
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(b.x,b.y);
    ctx.lineTo(b.x - head*Math.cos(ang- Math.PI/7), b.y - head*Math.sin(ang- Math.PI/7));
    ctx.lineTo(b.x - head*Math.cos(ang+ Math.PI/7), b.y - head*Math.sin(ang+ Math.PI/7));
    ctx.closePath(); ctx.fill();
  }

  function pixelate(a,b,px=10){
    const x=Math.min(a.x,b.x), y=Math.min(a.y,b.y), w=Math.abs(a.x-b.x), h=Math.abs(a.y-b.y)
    const img = ctx.getImageData(x,y,w,h)
    const data = img.data
    const step = Math.max(4, Math.floor(px))
    for(let j=0;j<h;j+=step){ for(let i=0;i<w;i+=step){
      const idx = ((j*w)+i)*4; const r=data[idx], g=data[idx+1], bl=data[idx+2], al=data[idx+3]
      for(let y2=0;y2<step;y2++){ for(let x2=0;x2<step;x2++){
        const k = (((j+y2)*w)+(i+x2))*4; if(k<data.length){ data[k]=r; data[k+1]=g; data[k+2]=bl; data[k+3]=al; }
      }}
    }}
    ctx.putImageData(img,x,y)
  }

  function drawCurrentTool(start,current){
    if(!start || !current) return;
    const width = parseInt(thick.value,10) || 1;
    ctx.strokeStyle=color.value;
    ctx.fillStyle=color.value;
    ctx.lineWidth=width;
    ctx.globalCompositeOperation='source-over';
    switch(state.tool){
      case 'rect':
        drawRect(start,current,false);
        break;
      case 'ellipse':
        drawEllipse(start,current,false);
        break;
      case 'arrow':
        drawArrow(start,current);
        break;
      case 'highlight':
        drawRect(start,current,true,.25);
        break;
      case 'redact':
        drawRect(start,current,true,1);
        break;
      case 'blur':
        pixelate(start,current,12);
        break;
    }
  }

  // Pointer events
  function pos(e){ const r=c.getBoundingClientRect(); return { x:(e.clientX-r.left)*(c.width/r.width)/dpr, y:(e.clientY-r.top)*(c.height/r.height)/dpr } }

  function start(e){
    if(!state.img) return alert('Carregue uma imagem primeiro.');
    if(state.tool==='text') return;
    state.down=true;
    state.start=pos(e);
    state.lastPos=state.start;
    state.snapshot=captureCanvas();
  }

  function move(e){
    if(!state.down) return;
    const p=pos(e);
    state.lastPos=p;
    restoreSnapshot(state.snapshot);
    drawCurrentTool(state.start,p);
  }

  function end(e){
    if(!state.down) return;
    const finalPoint = e && typeof e.clientX === 'number' ? pos(e) : (state.lastPos || state.start);
    restoreSnapshot(state.snapshot);
    drawCurrentTool(state.start, finalPoint);
    state.down=false;
    state.snapshot=null;
    state.start=null;
    state.lastPos=null;
    pushHistory();
  }

  c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end)

  // Text tool (floating input)
  function addTextAt(p){
    removeFloatingEditor();
    const rect=c.getBoundingClientRect();
    const scaleX = rect.width / (c.width / dpr);
    const scaleY = rect.height / (c.height / dpr);
    const anchorX = window.scrollX + rect.left + (p.x * scaleX);
    const anchorY = window.scrollY + rect.top + (p.y * scaleY);

    const wrapper=document.createElement('div');
    wrapper.className='floating-editor';
    wrapper.style.left=`${anchorX}px`;
    wrapper.style.top=`${anchorY}px`;

    const input=document.createElement('input');
    input.className='floating-input';
    input.placeholder='Digite e Enter';

    const menu=document.createElement('div');
    menu.className='floating-menu';

    const localColor=document.createElement('input');
    localColor.type='color';
    localColor.value=color.value;
    localColor.title='Cor do texto';

    const fontSelect=document.createElement('select');
    fontSelect.title='Fonte do texto';
    const fonts=[
      { label:'Sans', value:"system-ui, -apple-system, 'Segoe UI', sans-serif" },
      { label:'Serif', value:"'Times New Roman','Georgia',serif" },
      { label:'Mono', value:"'JetBrains Mono','Fira Code','Courier New',monospace" }
    ];
    fonts.forEach(font=>{
      const opt=document.createElement('option');
      opt.value=font.value;
      opt.textContent=font.label;
      fontSelect.appendChild(opt);
    });

    menu.appendChild(localColor);
    menu.appendChild(fontSelect);
    wrapper.appendChild(input);
    wrapper.appendChild(menu);
    document.body.appendChild(wrapper);
    input.focus();

    function commit(){
      const txt=input.value.trim();
      removeFloatingEditor();
      if(!txt) return;
      const size=Math.max(12, parseInt(thick.value,10)*3);
      ctx.save();
      ctx.fillStyle=localColor.value;
      ctx.font = `700 ${size}px ${fontSelect.value}`;
      ctx.textBaseline='top';
      ctx.fillText(txt, p.x, p.y);
      ctx.restore();
      pushHistory();
    }

    input.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ commit(); }
      else if(e.key==='Escape'){ removeFloatingEditor(); }
    });

    state.floating=wrapper;
  }

  c.addEventListener('click', e=>{ if(state.tool==='text' && state.img){ addTextAt(pos(e)) } })

  async function copyCanvasToClipboard(){
    if(!state.img){
      alert('Carregue ou cole uma imagem antes de copiar.');
      return;
    }
    if(!(navigator.clipboard && navigator.clipboard.write) || typeof ClipboardItem === 'undefined'){
      alert('Clipboard API indisponível. Use Exportar PNG.');
      return;
    }
    try{
      const blob = await new Promise((resolve,reject)=> c.toBlob(b=> b?resolve(b):reject(new Error('Falha ao gerar imagem')), 'image/png'));
      if(!blob) throw new Error('Canvas vazio');
      await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
      if(copyBtn){
        copyBtn.textContent='Copiado!';
        setTimeout(()=> copyBtn.textContent=copyBtnDefault, 1800);
      }
    }catch(err){
      console.error(err);
      alert('Não consegui copiar para o clipboard. Use Exportar PNG como alternativa.');
    }
  }

  undoBtn.addEventListener('click', undo)
  clearBtn.addEventListener('click', clear)
  if(copyBtn) copyBtn.addEventListener('click', copyCanvasToClipboard)
  exportBtn.addEventListener('click', ()=>{
    const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=`annotated-${Date.now()}.png`; a.click();
  })

  // Keyboard shortcuts
  window.addEventListener('keydown', e=>{
    const target=e.target;
    const isTyping = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);
    if(isTyping) return;
    if(e.ctrlKey||e.metaKey){
      const key=e.key.toLowerCase();
      if(key==='z'){ e.preventDefault(); undo(); }
      else if(key==='c'){ e.preventDefault(); copyCanvasToClipboard(); }
    }
  })
  </script>

  <section class="wrap" style="margin:28px auto 48px">
    <h2>Como publicar (GitHub Pages ΓÇô 3 passos)</h2>
    <ol>
      <li>Crie um reposit├│rio no GitHub (ex.: <strong>screenshot-annotator</strong>).</li>
      <li>Salve este arquivo como <code>index.html</code> na raiz e fa├ºa commit.</li>
      <li>Em <strong>Settings ΓåÆ Pages</strong>, escolha <em>Deploy from a branch</em>, branch <strong>main</strong>, pasta <strong>/root</strong>. Pronto, voc├¬ tem uma URL p├║blica.</li>
    </ol>
  </section>
</body>
</html>
